{% extends "base.html" %}
{% block content %}
  <h2>–ü—Ä–æ–µ–∫—Ç {{ project.code }} ‚Äî {{ project.name }}</h2>
  <p class="muted">–°–æ–∑–¥–∞–Ω: {{ project.date_created }} ¬∑ –°—Ç–∞—Ç—É—Å: {{ project.status }} ¬∑ –ü–ª–∞–Ω —á–∞—Å–æ–≤: {{ '%.1f'|format(project.planned_hours or 0) }}</p>

  <article>
    <h3>–ó–∞–¥–∞—á–∏ –ø—Ä–æ–µ–∫—Ç–∞</h3>
    <div class="table-wrapper sticky-table">
      <table>
        <thead>
          <tr>
            <th scope="col" class="col-action" aria-label="–ò—Å—Ç–æ—Ä–∏—è"></th>
            <th scope="col">–ó–∞–¥–∞—á–∞</th>
            <th scope="col">–°—Ç–∞—Ç—É—Å</th>
            <th scope="col">–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
            <th scope="col">–°—Ä–æ–∫</th>
            <th scope="col">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
            <th scope="col">–°–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</th>
            <th scope="col">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ</th>
          </tr>
        </thead>
        <tbody>
          {% for t in tasks %}
          {% set approved = (t.collaborators | selectattr('approved') | list) %}
          {% set pending = (t.collaborators | rejectattr('approved') | list) %}
          {% set last_log = t.status_logs[-1] if t.status_logs|length > 0 else None %}
          <tr>
            <td class="cell-history">
              <button type="button" class="timeline-btn" hx-get="/tasks/{{ t.id }}/timeline" hx-target="#task-timeline-body" hx-swap="innerHTML" hx-on::after-swap="window.TimeflowTaskModal.open()" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–¥–∞—á–∏">
                üïò
              </button>
            </td>
            <td class="cell-main">
              <div class="task-title">{{ t.title }}</div>
              {% if t.description %}<p class="task-desc">{{ t.description }}</p>{% endif %}
              <div class="task-meta-line">
                <span class="pill pill--project">{{ project.code }}</span>
                <span class="pill pill--priority priority-{{ t.priority|enum_value }}">{{ t.priority|priority_label }}</span>
              </div>
            </td>
            <td class="cell-status">
              <span class="badge status-{{ t.status|enum_value }}">{{ t.status|status_label }}</span>
              {% if last_log %}<small class="muted">–æ–±–Ω–æ–≤–ª–µ–Ω–æ {{ last_log.created_at.strftime('%d.%m %H:%M') }}</small>{% endif %}
            </td>
            <td class="cell-progress">{{ t.percent_complete }}%</td>
            <td class="cell-dates">
              {% if t.due_date %}<strong>{{ t.due_date }}</strong>{% else %}<span class="muted">–±–µ–∑ —Å—Ä–æ–∫–∞</span>{% endif %}
              {% if t.start_date %}<small class="muted">—Å—Ç–∞—Ä—Ç {{ t.start_date }}</small>{% endif %}
            </td>
            <td class="cell-assignee">{{ t.assignee.full_name }}</td>
            <td class="cell-collaborators">
              {% if approved %}
                {% for coll in approved %}<span class="pill">{{ coll.user.full_name }}</span>{% endfor %}
              {% endif %}
              {% if pending %}
                {% for coll in pending %}<span class="pill pill--pending" title="–û–∂–∏–¥–∞–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è">{{ coll.user.full_name }}</span>{% endfor %}
              {% endif %}
              {% if not approved and not pending %}<span class="muted">‚Äî</span>{% endif %}
            </td>
            <td class="cell-approval">{% if t.approved %}<span class="badge status-done">–û–¥–æ–±—Ä–µ–Ω–æ</span>{% else %}<span class="badge status-waiting">–Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</span>{% endif %}</td>
          </tr>
          {% endfor %}
          {% if tasks|length == 0 %}
          <tr><td colspan="8" class="muted">–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </article>

  <article>
    <h3>–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –ø–æ–¥–∑–∞–¥–∞—á</h3>
    <ul class="subtask-timeline">
      {% for link in subtasks %}
        <li>
          <div>
            <strong>{{ link.task.title }}</strong>
            <small class="muted">{{ link.created_at.strftime('%d.%m %H:%M') }}</small>
          </div>
          <div class="subtask-meta">
            <span class="badge status-{{ link.task.status|enum_value }}">{{ link.task.status|status_label }}</span>
            <span class="pill pill--priority priority-{{ link.task.priority|enum_value }}">{{ link.task.priority|priority_label }}</span>
            <span class="pill">{{ link.task.assignee.full_name }}</span>
          </div>
          <button type="button" class="timeline-btn" hx-get="/tasks/{{ link.task.id }}/timeline" hx-target="#task-timeline-body" hx-swap="innerHTML" hx-on::after-swap="window.TimeflowTaskModal.open()">–ò—Å—Ç–æ—Ä–∏—è</button>
        </li>
      {% else %}
        <li class="muted">–ü–æ–¥–∑–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á—É, —á—Ç–æ–±—ã –æ–Ω–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ –ø—Ä–æ–µ–∫—Ç–µ.</li>
      {% endfor %}
    </ul>
  </article>

  <article>
    <h3>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</h3>
    <form method="post" action="/tasks/new" class="project-task-form">
      <input type="hidden" name="project_id" value="{{ project.id }}">
      <label><span>–ó–∞–≥–æ–ª–æ–≤–æ–∫</span><input type="text" name="title" required></label>
      <label><span>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</span>
        <select name="priority">
          {% for p in Priority %}<option value="{{ p.value }}">{{ p|priority_label }}</option>{% endfor %}
        </select>
      </label>
      <label class="wide"><span>–û–ø–∏—Å–∞–Ω–∏–µ</span><textarea name="description"></textarea></label>
      <label><span>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</span>
        <select name="assignee_id" required>
          {% for u in users %}<option value="{{ u.id }}">{{ u.full_name }}</option>{% endfor %}
        </select>
      </label>
      <label><span>–°–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</span>
        <select name="collaborator_ids" multiple size="4">
          {% for u in users %}<option value="{{ u.id }}">{{ u.full_name }}</option>{% endfor %}
        </select>
        <small class="muted">–°–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –Ω–∞—á–Ω—É—Ç —Ä–∞–±–æ—Ç—É –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</small>
      </label>
      <label><span>–ù–∞—á–∞–ª–æ</span><input type="date" name="start_date"></label>
      <label><span>–°—Ä–æ–∫</span><input type="date" name="due_date"></label>
      <button type="submit" class="primary">–°–æ–∑–¥–∞—Ç—å</button>
    </form>
    <p class="muted">–ï—Å–ª–∏ –∑–∞–¥–∞—á—É —Å–æ–∑–¥–∞—ë—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, –æ–Ω–∞ –ø–æ—è–≤–∏—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ¬´–Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏¬ª –¥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</p>
  </article>

  {% if user.role in ['manager','admin'] %}
  <article>
    <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞</h3>
    <table>
      <thead><tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
      <tbody>
        {% for m in members %}
        <tr>
          <td>{{ m.user.full_name }}</td>
          <td>
            <form method="post" action="/projects/{{ project.id }}/members/remove">
              <input type="hidden" name="member_id" value="{{ m.id }}">
              <button class="secondary">–ò—Å–∫–ª—é—á–∏—Ç—å</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <form method="post" action="/projects/{{ project.id }}/members/add" class="grid">
      <label>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞
        <select name="user_id">
          {% for u in users %}<option value="{{ u.id }}">{{ u.full_name }}</option>{% endfor %}
        </select>
      </label>
      <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
    <p class="muted">–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ–µ–∫—Ç–∞, —É—á–∞—Å—Ç–Ω–∏–∫–∏, –º–µ–Ω–µ–¥–∂–µ—Ä—ã –∏ –∞–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç –ø—Ä–æ–µ–∫—Ç –≤ —Ç–∞–±–µ–ª–µ –∏ –º–æ–≥—É—Ç —Å–ø–∏—Å—ã–≤–∞—Ç—å –Ω–∞ –Ω–µ–≥–æ –≤—Ä–µ–º—è.</p>
  </article>
  {% endif %}

  <dialog id="task-timeline-modal" class="task-timeline-modal">
    <article id="task-timeline-body" class="timeline-modal-body">
      <header class="timeline-modal-body__header">
        <strong>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</strong>
      </header>
      <p class="muted">–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞–¥–∞—á–∏.</p>
    </article>
  </dialog>

  <script>
    (function(){
      const dialog = document.getElementById('task-timeline-modal');
      window.TimeflowTaskModal = window.TimeflowTaskModal || {
        open(){ if(dialog && !dialog.open){ dialog.showModal(); } },
        close(){ if(dialog && dialog.open){ dialog.close(); } }
      };
      if(dialog){
        dialog.addEventListener('click', (event)=>{
          if(event.target === dialog){ window.TimeflowTaskModal.close(); }
        });
      }
    })();
  </script>

  <style>
    .table-wrapper table{ min-width:1100px; }
    .col-action{ width:54px; text-align:center; }
    .timeline-btn{
      border-radius:999px;
      border:1px solid var(--pico-primary-border-color, var(--pico-color));
      background:transparent;
      width:40px; height:40px;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:1.1rem;
      transition:background .2s ease, transform .2s ease;
    }
    .timeline-btn:hover{ background:var(--pico-primary-background); color:var(--pico-primary-inverse); transform:translateY(-1px); }
    .cell-main{ min-width:22rem; }
    .task-title{ font-weight:600; }
    .task-desc{ margin:.3rem 0 0; color:var(--pico-muted-color); }
    .task-meta-line{ margin-top:.4rem; display:flex; gap:.4rem; flex-wrap:wrap; }
    .pill{ display:inline-flex; align-items:center; gap:.35rem; border-radius:999px; padding:.2rem .75rem; background:var(--pico-muted-color,#d9d9d9); color:var(--pico-color,#111); font-size:.8rem; font-weight:500; }
    .pill--project{ background:var(--pico-secondary-background); color:var(--pico-secondary-inverse); }
    .pill--priority{ text-transform:lowercase; }
    .priority-critical{ background:var(--pico-danger-background); color:var(--pico-danger-inverse); }
    .priority-high{ background:var(--pico-warning-background); color:var(--pico-warning-inverse); }
    .priority-medium{ background:var(--pico-secondary-background); color:var(--pico-secondary-inverse); }
    .priority-low{ background:var(--pico-muted-border-color); color:var(--pico-color); }
    .pill--pending{ background:var(--pico-warning-background); color:var(--pico-warning-inverse); }
    .cell-progress{ font-weight:600; }
    .subtask-timeline{ list-style:none; padding:0; margin:0; display:grid; gap:.75rem; }
    .subtask-timeline li{ display:grid; grid-template-columns:1fr auto auto; gap:1rem; align-items:center; padding:.75rem; border:1px solid var(--pico-muted-border-color); border-radius:.75rem; }
    .subtask-timeline li strong{ display:block; }
    .subtask-meta{ display:flex; flex-wrap:wrap; gap:.4rem; }
    .project-task-form{
      display:grid;
      grid-template-columns:repeat(3, minmax(220px, 1fr));
      gap:1rem;
      align-items:end;
    }
    .project-task-form .wide{ grid-column:1 / -1; }
    .project-task-form textarea{ min-height:3rem; resize:vertical; }
    .project-task-form button{ width:max-content; justify-self:start; }
    .project-task-form select[multiple]{ height:120px; }
    .task-timeline-modal::backdrop{ backdrop-filter:blur(2px); background:rgba(0,0,0,.35); }
    .timeline-modal-body{ min-width:min(640px, 90vw); max-height:80vh; overflow-y:auto; }
    @media (max-width: 960px){
      .subtask-timeline li{ grid-template-columns:1fr; }
      .subtask-meta{ justify-content:flex-start; }
      .project-task-form{ grid-template-columns:repeat(2, minmax(200px,1fr)); }
    }
    @media (max-width: 680px){
      .table-wrapper table{ min-width:900px; }
      .project-task-form{ grid-template-columns:1fr; }
    }
  </style>
{% endblock %}
