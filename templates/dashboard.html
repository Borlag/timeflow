{% extends "base.html" %}
{% block content %}
  <header class="page-header">
    <div>
      <h1>Дэшборд</h1>
      <p class="muted">Обновлено на {{ today.strftime('%d.%m.%Y') }}</p>
    </div>
    <div class="range-chip" aria-live="polite">
      <span>Период:</span>
      <strong>{{ start.strftime('%d.%m.%Y') }} — {{ end.strftime('%d.%m.%Y') }}</strong>
    </div>
  </header>

  <section class="grid-two">
    <details class="surface">
      <summary>Посещаемость</summary>
      <div class="button-group" role="group" aria-label="Управление посещаемостью">
        <form method="post" action="/attendance/checkin">
          <button type="submit" {% if attendance and attendance.check_in %}disabled{% endif %}>Чек-ин</button>
        </form>
        <form method="post" action="/attendance/checkout">
          <button type="submit">Чек-аут</button>
        </form>
      </div>
      {% if attendance %}
        <p>Сегодня: {% if attendance.check_in %}начало {{ attendance.check_in.strftime("%H:%M") }}{% else %}—{% endif %}
        {% if attendance.check_out %}, конец {{ attendance.check_out.strftime("%H:%M") }}{% endif %}</p>
      {% else %}
        <p class="muted">Отметки за сегодня ещё не созданы.</p>
      {% endif %}
      {% if recommended_leave %}
        <p>Рекомендуемое время ухода: <strong>{{ recommended_leave.strftime("%H:%M") }}</strong> (норма {{ '%g'|format(SHIFT_HOURS) }} ч).</p>
      {% endif %}
    </details>

    <article class="surface">
      <header>Табель</header>
      <p>За сегодня введено часов: <strong>{{ '%.2f'|format(hours_logged_today) }}</strong>.</p>
      <p class="muted">Откройте <a href="/timesheet">табель</a>, чтобы дополнить или исправить данные.</p>
    </article>
  </section>

  <section class="surface tasks-card">
    <div class="section-head">
      <h2>Мои задачи</h2>
      <nav class="segmented" aria-label="Горизонт планирования">
        <a href="/dashboard?horizon=today" class="{% if horizon == 'today' %}active{% endif %}">Сегодня</a>
        <a href="/dashboard?horizon=week" class="{% if horizon == 'week' %}active{% endif %}">Неделя</a>
        <a href="/dashboard?horizon=month" class="{% if horizon == 'month' %}active{% endif %}">Месяц</a>
      </nav>
    </div>
    <div class="table-wrapper sticky-table {% if tasks|length > 12 %}stick{% endif %}">
      <table>
        <thead><tr><th>Задача</th><th>Проект</th><th>Статус</th><th>%</th><th>Дедлайн</th><th>Действия</th></tr></thead>
        <tbody>
        {% for t in tasks %}
          <tr>
            <td>
              <strong class="priority-{{ t.priority|enum_value }}">{{ t.title }}</strong><br>
              <small>{{ t.description }}</small>
            </td>
            <td>{{ t.project.code if t.project else "—" }}</td>
            <td><span class="badge status-{{ t.status|enum_value }}">{{ t.status|status_label }}</span></td>
            <td>{{ t.percent_complete }}%</td>
            <td>{{ t.due_date or "—" }}</td>
            <td>
              <details>
                <summary>Обновить</summary>
                <form method="post" action="/tasks/update_status">
                  <input type="hidden" name="task_id" value="{{ t.id }}">
                  <label>Статус
                    <select name="status_v">
                      {% for s in TaskStatus %}
                      <option value="{{ s.value }}" {% if s==t.status %}selected{% endif %}>{{ s|status_label }}</option>
                      {% endfor %}
                    </select>
                  </label>
                  <label>% выполнения <input type="number" name="percent" min="0" max="100" value="{{ t.percent_complete }}"></label>
                  <label>Комментарий <input type="text" name="comment" placeholder="почему пауза / ожидание и т.п."></label>
                  <button type="submit">Сохранить</button>
                </form>
              </details>
            </td>
          </tr>
        {% endfor %}
        {% if tasks|length == 0 %}
          <tr><td colspan="6" class="muted">Нет задач на выбранный период.</td></tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </section>
  <style>
    /* Секция «Мои задачи»: компактный отступ и ровный заголовок */
    .tasks-card .section-head{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:.5rem}
    .tasks-card h2{margin:0}
    .tasks-card .table-wrapper{margin-top:0}
  </style>
{% endblock %}
