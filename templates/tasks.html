{% extends "base.html" %}
{% block content_class %} content--wide{% endblock %}
{% block content %}
  <h2>Задачи {% if request.query_params.get('mine') == '1' %}(мои){% endif %}</h2>
  <nav class="segmented" aria-label="Фильтр списка задач">
    <a href="/tasks?mine=1" class="{% if request.query_params.get('mine') == '1' %}active{% endif %}">Мои</a>
    <a href="/tasks?mine=0" class="{% if request.query_params.get('mine') != '1' %}active{% endif %}">Все</a>
  </nav>

  <div class="table-wrapper sticky-table {% if tasks|length > 12 %}stick{% endif %}">
    <table>
      <thead><tr><th>Заголовок</th><th>Проект</th><th>Статус</th><th>Приоритет</th><th>%</th><th>Срок</th><th>Исполнитель</th><th>Согласование</th></tr></thead>
      <tbody>
        {% for t in tasks %}
        <tr>
          <td><strong>{{ t.title }}</strong><br><small>{{ t.description }}</small></td>
          <td>{{ t.project.code if t.project else "—" }}</td>
          <td><span class="badge status-{{ t.status|enum_value }}">{{ t.status|status_label }}</span></td>
          <td>{{ t.priority|priority_label }}</td>
          <td>{{ t.percent_complete }}%</td>
          <td>{{ t.due_date or "—" }}</td>
          <td>{{ t.assignee.full_name }}</td>
          <td>{% if t.approved %}OK{% else %}<span class="badge status-waiting">на согласовании</span>{% endif %}</td>
        </tr>
        {% endfor %}
        {% if tasks|length == 0 %}
        <tr><td colspan="8" class="muted">Нет задач</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <hr>
  <h3>Создать задачу</h3>
  <form method="post" action="/tasks/new" class="create-task-form">
    <label><span>Заголовок</span><input type="text" name="title" required></label>
    <label><span>Приоритет</span>
      <select name="priority">
        {% for p in Priority %}<option value="{{ p.value }}">{{ p|priority_label }}</option>{% endfor %}
      </select>
    </label>
    <label class="col-span-2"><span>Описание</span><textarea name="description"></textarea></label>
    <label><span>Проект</span>
      <select name="project_id">
        <option value="">—</option>
        {% for p in projects %}<option value="{{ p.id }}">{{ p.code }} — {{ p.name }}</option>{% endfor %}
      </select>
    </label>
    <label><span>Исполнитель</span>
      <select name="assignee_id" required>
        {% for u in users %}<option value="{{ u.id }}">{{ u.full_name }}</option>{% endfor %}
      </select>
    </label>
    <label><span>Начало</span><input type="date" name="start_date"></label>
    <label><span>Срок</span><input type="date" name="due_date"></label>
    <button type="submit" class="primary">Создать</button>
  </form>
  <style>
    /* Чёткая сетка формы + идеальная центровка кнопки */
    .create-task-form{
      display:grid;
      grid-template-columns:repeat(4, minmax(220px, 1fr));
      gap:1rem;
      align-items:end;
    }
    .create-task-form .col-span-2{ grid-column:span 2; }
    .create-task-form textarea{ min-height:3rem; resize:vertical; }
    .create-task-form button{
      height:44px;
      display:flex; align-items:center; justify-content:center;
      width:max-content;            /* не растягиваем на всю колонку */
      justify-self:start;           /* прижимаем к левому краю сетки */
      padding-inline:1.2rem;
    }
    @media (max-width: 1100px){ .create-task-form{ grid-template-columns:repeat(2,1fr); } }
    @media (max-width: 700px){ .create-task-form{ grid-template-columns:1fr; } }
  </style>
  <p class="muted">Если задачу создаёт сотрудник, она появится у него с пометкой «на согласовании» до одобрения менеджером/админом.</p>
{% endblock %}
