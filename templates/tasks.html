{% extends "base.html" %}
{% block content_class %} content--wide{% endblock %}
{% block content %}
  <h2>–ó–∞–¥–∞—á–∏ {% if mine|int == 1 %}(–º–æ–∏){% endif %}</h2>
  <nav class="segmented" aria-label="–§–∏–ª—å—Ç—Ä —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á">
    <a href="/tasks?mine=1" class="{% if mine|int == 1 %}active{% endif %}">–ú–æ–∏</a>
    <a href="/tasks?mine=0" class="{% if mine|int != 1 %}active{% endif %}">–í—Å–µ</a>
  </nav>

  <form method="get" class="tasks-filter-panel" aria-label="–§–∏–ª—å—Ç—Ä—ã –∑–∞–¥–∞—á">
    <input type="hidden" name="mine" value="{{ mine }}">
    <label class="tasks-filter-panel__field">
      <span>–ü–æ–∏—Å–∫</span>
      <input type="search" name="q" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ" value="{{ search_query }}">
    </label>
    <label class="tasks-filter-panel__field">
      <span>–°—Ç–∞—Ç—É—Å</span>
      <select name="status_filter">
        <option value="">–õ—é–±–æ–π</option>
        {% for st in TaskStatus %}
          <option value="{{ st.value }}" {% if status_filter == st.value %}selected{% endif %}>{{ st|status_label }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="tasks-filter-panel__field">
      <span>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</span>
      <select name="priority_filter">
        <option value="">–õ—é–±–æ–π</option>
        {% for pr in Priority %}
          <option value="{{ pr.value }}" {% if priority_filter == pr.value %}selected{% endif %}>{{ pr|priority_label }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="tasks-filter-panel__field">
      <span>–ü—Ä–æ–µ–∫—Ç</span>
      <select name="project_filter">
        <option value="">–õ—é–±–æ–π</option>
        {% for p in projects %}
          <option value="{{ p.id }}" {% if project_filter and project_filter|int == p.id %}selected{% endif %}>{{ p.code }} ‚Äî {{ p.name }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="tasks-filter-panel__field">
      <span>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</span>
      <select name="assignee_filter">
        <option value="">–õ—é–±–æ–π</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if assignee_filter and assignee_filter|int == u.id %}selected{% endif %}>{{ u.full_name }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="tasks-filter-panel__field">
      <span>–°–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</span>
      <select name="collaborator_filter">
        <option value="">–õ—é–±–æ–π</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if collaborator_filter and collaborator_filter|int == u.id %}selected{% endif %}>{{ u.full_name }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="tasks-filter-panel__field">
      <span>–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ</span>
      <select name="approved_filter">
        <option value="">–õ—é–±–æ–µ</option>
        <option value="pending" {% if approved_filter == 'pending' %}selected{% endif %}>–¢—Ä–µ–±—É–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</option>
        <option value="approved" {% if approved_filter == 'approved' %}selected{% endif %}>–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</option>
      </select>
    </label>
    <label class="tasks-filter-panel__field">
      <span>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</span>
      <select name="sort">
        {% for key, label in sort_options.items() %}
          <option value="{{ key }}" {% if sort == key %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </label>
    <div class="tasks-filter-panel__actions">
      <button type="submit" class="primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <a class="secondary" href="/tasks?mine={{ mine }}">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </div>
  </form>

  {% if filter_summary %}
  <div class="filter-summary" role="status" aria-live="polite">
    {% for chip in filter_summary %}
      <span class="chip">{{ chip }}</span>
    {% endfor %}
  </div>
  {% endif %}

  <div class="table-wrapper sticky-table {% if tasks|length > 12 %}stick{% endif %}">
    <table>
      <thead>
        <tr>
          <th scope="col" class="col-action" aria-label="–ò—Å—Ç–æ—Ä–∏—è"></th>
          <th scope="col">–ó–∞–¥–∞—á–∞</th>
          <th scope="col">–ü—Ä–æ–µ–∫—Ç</th>
          <th scope="col">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
          <th scope="col">–°—Ç–∞—Ç—É—Å</th>
          <th scope="col">–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
          <th scope="col">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
          <th scope="col">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</th>
          <th scope="col">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
          <th scope="col">–°–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</th>
          <th scope="col">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
          <th scope="col">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ</th>
        </tr>
      </thead>
      <tbody>
        {% for t in tasks %}
        {% set meta = task_meta.get(t.id) %}
        <tr>
          <td class="cell-history">
            <button
              type="button"
              class="timeline-btn"
              hx-get="/tasks/{{ t.id }}/timeline"
              hx-target="#task-timeline-body"
              hx-swap="innerHTML"
              data-task-timeline-trigger
              data-focus="history"
              aria-label="–û—Ç–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–¥–∞—á–∏"
            >
              üïò
            </button>
          </td>
          <td class="cell-main">
            <div class="task-title">{{ t.title }}</div>
            {% if t.description %}<p class="task-desc">{{ t.description }}</p>{% endif %}
          </td>
          <td class="cell-project">
            {% if t.project %}
              <span class="pill pill--project">{{ t.project.code }}</span>
              <small class="muted">{{ t.project.name }}</small>
            {% else %}
              <span class="muted">–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞</span>
            {% endif %}
          </td>
          <td class="cell-priority">
            <span class="pill pill--priority priority-{{ t.priority|enum_value }}">{{ t.priority|priority_label }}</span>
          </td>
          <td class="cell-status">
            <span class="badge status-{{ t.status|enum_value }}">{{ t.status|status_label }}</span>
          </td>
          <td class="cell-progress">
            <span class="progress-value">{{ t.percent_complete }}%</span>
          </td>
          <td class="cell-start">
            {% if t.start_date %}
              <strong>{{ t.start_date }}</strong>
            {% else %}
              <span class="muted">‚Äî</span>
            {% endif %}
          </td>
          <td class="cell-due">
            {% if t.due_date %}
              <strong>{{ t.due_date }}</strong>
            {% else %}
              <span class="muted">‚Äî</span>
            {% endif %}
          </td>
          <td class="cell-assignee">
            <strong>{{ t.assignee.full_name }}</strong>
          </td>
          <td class="cell-collaborators">
            {% set approved = meta['approved_collaborators'] if meta else [] %}
            {% set pending = meta['pending_collaborators'] if meta else [] %}
            {% if approved %}
              {% for coll in approved %}
                <span class="pill">{{ coll.user.full_name }}</span>
              {% endfor %}
            {% endif %}
            {% if pending %}
              {% for coll in pending %}
                <span class="pill pill--pending" title="–û–∂–∏–¥–∞–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è">{{ coll.user.full_name }}</span>
              {% endfor %}
            {% endif %}
            {% if not approved and not pending %}
              <span class="muted">‚Äî</span>
            {% endif %}
          </td>
          <td class="cell-activity">
            {% if meta %}
              <button
                type="button"
                class="activity-chip"
                hx-get="/tasks/{{ t.id }}/timeline"
                hx-target="#task-timeline-body"
                hx-swap="innerHTML"
                data-task-timeline-trigger
                data-focus="comments"
                aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∑–∞–¥–∞—á–µ ¬´{{ t.title }}¬ª"
              >
                üí¨ {{ meta['comment_count'] }}
              </button>
              {% set last = meta['last_activity'] %}
              <small class="muted">–û–±–Ω–æ–≤–ª–µ–Ω–æ {{ last.strftime('%d.%m %H:%M') }}</small>
            {% else %}
              <span class="muted">‚Äî</span>
            {% endif %}
          </td>
          <td class="cell-approval">
            {% if t.approved %}
              <span class="badge status-done">–û–¥–æ–±—Ä–µ–Ω–æ</span>
            {% else %}
              <span class="badge status-waiting">–Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if tasks|length == 0 %}
        <tr><td colspan="12" class="muted">–ù–µ—Ç –∑–∞–¥–∞—á</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <dialog id="task-timeline-modal" class="task-timeline-modal">
    <article id="task-timeline-body" class="timeline-modal-body" aria-live="polite">
      <header class="timeline-modal-body__header">
        <strong>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</strong>
      </header>
      <p class="muted">–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞–¥–∞—á–∏.</p>
    </article>
  </dialog>

  <hr>
  <h3>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h3>
  <form method="post" action="/tasks/new" class="create-task-form">
    <label class="col-span-6"><span>–ó–∞–≥–æ–ª–æ–≤–æ–∫</span><input type="text" name="title" required></label>
    <label class="col-span-3"><span>–ü—Ä–æ–µ–∫—Ç</span>
      <select name="project_id">
        <option value="">‚Äî</option>
        {% for p in projects %}<option value="{{ p.id }}">{{ p.code }} ‚Äî {{ p.name }}</option>{% endfor %}
      </select>
    </label>
    <label class="col-span-3"><span>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</span>
      <select name="priority">
        {% for p in Priority %}<option value="{{ p.value }}">{{ p|priority_label }}</option>{% endfor %}
      </select>
    </label>
    <label class="col-span-12"><span>–û–ø–∏—Å–∞–Ω–∏–µ</span><textarea name="description"></textarea></label>
    <label class="col-span-3"><span>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</span>
      <select name="assignee_id" required>
        {% for u in users %}<option value="{{ u.id }}">{{ u.full_name }}</option>{% endfor %}
      </select>
    </label>
    <label><span>–°–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</span>
      <select name="collaborator_ids" multiple size="4">
        {% for u in users %}<option value="{{ u.id }}">{{ u.full_name }}</option>{% endfor %}
      </select>
      <small class="muted">–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç –∑–∞–¥–∞—á—É –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</small>
    </label>
    <label><span>–ù–∞—á–∞–ª–æ</span><input type="date" name="start_date"></label>
    <label><span>–°—Ä–æ–∫</span><input type="date" name="due_date"></label>
    <button type="submit" class="primary">–°–æ–∑–¥–∞—Ç—å</button>
  </form>
  <p class="muted">–ï—Å–ª–∏ –∑–∞–¥–∞—á—É —Å–æ–∑–¥–∞—ë—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, –æ–Ω–∞ –ø–æ—è–≤–∏—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º ¬´–Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏¬ª –¥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</p>

  <script>
    (function(){
      const dialog = document.getElementById('task-timeline-modal');
      const bodyEl = document.getElementById('task-timeline-body');
      const defaultBodyContent = bodyEl ? bodyEl.innerHTML : '';

      function ensureOpen(){
        if (dialog && !dialog.open) {
          dialog.showModal();
        }
      }

      function setBody(html){
        if (bodyEl) {
          bodyEl.innerHTML = html;
        }
      }

      function renderError(status){
        const codeText = status ? ` (–∫–æ–¥ ${status})` : '';
        setBody(`
          <header class="timeline-modal-body__header">
            <strong>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</strong>
          </header>
          <p class="muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ${codeText}.</p>
        `);
        ensureOpen();
      }

      window.TimeflowTaskModal = {
        pendingFocus: null,
        open: ensureOpen,
        ensureOpen,
        close(){ if(dialog && dialog.open){ dialog.close(); } },
        showLoading(){ setBody(defaultBodyContent); },
        showError(status){ renderError(status); },
        focusSection(section){
          if(!bodyEl || !section){ return; }
          const target = bodyEl.querySelector(`[data-timeline-section="${section}"]`);
          if(target){
            if(!target.hasAttribute('tabindex')){
              target.setAttribute('tabindex', '-1');
              target.dataset.timelineTempFocus = '1';
            }
            target.focus({ preventScroll: true });
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            if(target.dataset.timelineTempFocus){
              target.addEventListener('blur', ()=>{
                target.removeAttribute('tabindex');
                delete target.dataset.timelineTempFocus;
              }, { once: true });
            }
          }
        }
      };

      if(dialog){
        dialog.addEventListener('click', (event)=>{
          if(event.target === dialog){ window.TimeflowTaskModal.close(); }
        });
      }

      document.body.addEventListener('htmx:beforeRequest', (event)=>{
        const trigger = event.detail && event.detail.elt;
        if(trigger && trigger.hasAttribute('data-task-timeline-trigger')){
          window.TimeflowTaskModal.pendingFocus = trigger.getAttribute('data-focus');
          window.TimeflowTaskModal.showLoading();
          window.TimeflowTaskModal.open();
        }
      });

      document.body.addEventListener('htmx:afterSwap', (event)=>{
        if(event.detail && event.detail.target && event.detail.target.id === 'task-timeline-body'){
          window.TimeflowTaskModal.ensureOpen();
          if(window.TimeflowTaskModal.pendingFocus){
            window.TimeflowTaskModal.focusSection(window.TimeflowTaskModal.pendingFocus);
            window.TimeflowTaskModal.pendingFocus = null;
          }
        }
      });

      document.body.addEventListener('htmx:responseError', (event)=>{
        const trigger = event.detail && event.detail.elt;
        if(trigger && trigger.hasAttribute('data-task-timeline-trigger')){
          const status = event.detail && event.detail.xhr ? event.detail.xhr.status : undefined;
          window.TimeflowTaskModal.pendingFocus = null;
          window.TimeflowTaskModal.showError(status);
        }
      });
    })();
  </script>

  <style>
    .tasks-filter-panel{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
      gap:1rem;
      margin:1.2rem 0 1.5rem;
      align-items:end;
    }
    .tasks-filter-panel__field span{ font-size:.85rem; font-weight:500; }
    .tasks-filter-panel__actions{ display:flex; gap:.75rem; align-items:center; }
    .filter-summary{ display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:1rem; }
    .chip{ display:inline-flex; align-items:center; gap:.4rem; border-radius:999px; padding:.25rem .8rem; background:var(--pico-muted-color,#d6d6d6); color:var(--pico-color,#111); font-size:.85rem; }
    .table-wrapper table{ min-width:1300px; }
    .col-action{ width:54px; text-align:center; }
    .cell-history{ text-align:center; vertical-align:top; }
    .timeline-btn{
      border-radius:999px;
      border:1px solid var(--pico-primary-border-color, var(--pico-color));
      background:transparent;
      width:40px; height:40px;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:1.1rem;
      transition:background .2s ease, transform .2s ease;
    }
    .timeline-btn:hover{ background:var(--pico-primary-background); color:var(--pico-primary-inverse); transform:translateY(-1px); }
    .timeline-btn:focus-visible{ outline:2px solid var(--pico-primary-border-color, var(--pico-color)); outline-offset:2px; }
    .cell-main{ min-width:22rem; vertical-align:top; }
    .task-title{ font-weight:600; font-size:1.05rem; }
    .task-desc{ margin:.35rem 0 0; color:var(--pico-muted-color); font-size:.9rem; }
    .pill{ display:inline-flex; align-items:center; gap:.35rem; border-radius:999px; padding:.2rem .75rem; background:var(--pico-muted-color,#d9d9d9); color:var(--pico-color,#111); font-size:.8rem; font-weight:500; }
    .pill--project{ background:var(--pico-secondary-background); color:var(--pico-secondary-inverse); }
    .pill--priority{ text-transform:lowercase; }
    .priority-critical{ background:var(--pico-danger-background); color:var(--pico-danger-inverse); }
    .priority-high{ background:var(--pico-warning-background); color:var(--pico-warning-inverse); }
    .priority-medium{ background:var(--pico-secondary-background); color:var(--pico-secondary-inverse); }
    .priority-low{ background:var(--pico-muted-border-color); color:var(--pico-color); }
    .pill--pending{ background:var(--pico-warning-background); color:var(--pico-warning-inverse); }
    .cell-project{ min-width:12rem; vertical-align:top; }
    .cell-project small{ display:block; margin-top:.2rem; }
    .cell-priority, .cell-status, .cell-progress, .cell-start, .cell-due, .cell-assignee, .cell-collaborators, .cell-activity, .cell-approval{ vertical-align:top; }
    .cell-progress, .cell-start, .cell-due{ white-space:nowrap; }
    .cell-start strong, .cell-due strong{ display:block; }
    .cell-assignee strong{ display:block; }
    .cell-collaborators{ display:flex; flex-direction:column; gap:.3rem; }
    .cell-activity{ display:flex; flex-direction:column; align-items:flex-start; gap:.35rem; }
    .activity-chip{ display:inline-flex; align-items:center; gap:.35rem; border-radius:999px; padding:.25rem .8rem; border:1px solid var(--pico-primary-border-color, var(--pico-color)); background:transparent; color:var(--pico-primary-border-color, var(--pico-color)); font-size:.8rem; cursor:pointer; transition:background .2s ease, color .2s ease, transform .2s ease; }
    .activity-chip:hover{ background:var(--pico-primary-background); color:var(--pico-primary-inverse); transform:translateY(-1px); }
    .activity-chip:focus-visible{ outline:2px solid var(--pico-primary-border-color, var(--pico-color)); outline-offset:2px; }
    .cell-activity small{ display:block; margin-top:.1rem; }
    .progress-value{ font-weight:600; }
    .task-timeline-modal::backdrop{ backdrop-filter:blur(2px); background:rgba(0,0,0,.35); }
    .timeline-modal-body{ min-width:min(640px, 90vw); max-height:80vh; overflow-y:auto; }
    .timeline-modal-body__header{ display:flex; justify-content:space-between; align-items:center; gap:1rem; }
    .create-task-form{
      display:grid;
      grid-template-columns:repeat(12, minmax(0, 1fr));
      gap:1rem;
      align-items:start;
    }
    .create-task-form label{ display:flex; flex-direction:column; gap:.45rem; }
    .create-task-form .col-span-3{ grid-column:span 3; }
    .create-task-form .col-span-6{ grid-column:span 6; }
    .create-task-form .col-span-12{ grid-column:span 12; }
    .create-task-form textarea{ min-height:4.5rem; resize:vertical; }
    .create-task-form select[multiple]{ height:140px; }
    .create-task-form .form-actions{ display:flex; justify-content:flex-start; }
    .create-task-form .form-actions button{
      height:44px;
      display:flex; align-items:center; justify-content:center;
      width:max-content;
      justify-self:start;
      padding-inline:1.2rem;
    }
    .create-task-form select[multiple]{ height:120px; }
    @media (max-width: 1100px){
      .create-task-form{ grid-template-columns:repeat(2,1fr); }
      .tasks-filter-panel{ grid-template-columns:repeat(2, minmax(200px,1fr)); }
    }
    @media (max-width: 760px){
      .table-wrapper table{ min-width:1000px; }
    }
    @media (max-width: 700px){
      .create-task-form{ grid-template-columns:1fr; }
      .tasks-filter-panel{ grid-template-columns:1fr; }
    }
  </style>
{% endblock %}
