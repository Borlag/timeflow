{% extends "base.html" %}
{% block content %}
  {% set prev = date - datetime.timedelta(days=1) %}
  {% set next = date + datetime.timedelta(days=1) %}
  {% set today = datetime.date.today() %}
  <h2>Табель на дату {{ date.isoformat() }}</h2>
  {% if error_message %}
    <article class="secondary">{{ error_message }}</article>
  {% endif %}
  <p class="muted">Выберите <strong>задачу</strong> или <strong>проект</strong>. Если выбраны оба — учитывается задача. По умолчанию прямой ввод за предыдущий день; остальные даты — на согласовании.</p>

  <article>
    <form method="post" action="/timesheet/add" class="ts-form">
      <input type="hidden" name="date" value="{{ date.isoformat() }}">
      <label><span>Проект</span>
        <select name="project_id">
          <option value="">—</option>
          {% for p in projects %}
            <option value="{{ p.id }}">{{ p.code }} — {{ p.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label><span>Задача</span>
        <select name="task_id">
          <option value="">—</option>
          {% for t in tasks %}
          <option value="{{ t.id }}">{{ t.project.code if t.project else "—" }} — {{ t.title }}</option>
          {% endfor %}
        </select>
      </label>
      <label><span>Часы</span>
        <input type="number" name="hours" step="0.25" min="0" required inputmode="decimal" placeholder="напр. 2.5">
      </label>
      <label><span>Комментарий</span>
        <input type="text" name="notes" placeholder="что делал(а)">
      </label>
      <button type="submit">Добавить запись</button>
    </form>
  </article>
  <style>
    .ts-form{
      display:grid;
      grid-template-columns:1.1fr 1.6fr .7fr 2fr auto;
      gap:1rem;
      align-items:end;
    }
    .ts-form button{ height:44px; display:flex; align-items:center; justify-content:center; }
    @media (max-width: 900px){ .ts-form{ grid-template-columns:1fr; } }
  </style>

  <h3>Введённые записи</h3>
  <div class="table-wrapper sticky-table {% if entries|length > 12 %}stick{% endif %}">
    <table>
      <thead><tr><th>Проект/Задача</th><th>Часы</th><th>Статус</th><th>Комментарий</th><th>Действия</th></tr></thead>
      <tbody>
        {% for e in entries %}
        <tr>
          <td>
            {% if e.task %}
              {{ e.task.project.code if e.task.project else "—" }} — {{ e.task.title }}
            {% elif e.project %}
              {{ e.project.code }} — (без задачи)
            {% else %}
              Непроектная
            {% endif %}
          </td>
          <td>{{ '%.2f'|format(e.hours) }}</td>
          <td>{% if e.approved %}<span class="badge status-done">OK</span>{% else %}<span class="badge status-waiting">на согласовании</span>{% endif %}</td>
          <td>{{ e.notes }}</td>
          <td>
            {% if not e.locked %}
            <form method="post" action="/timesheet/delete">
              <input type="hidden" name="entry_id" value="{{ e.id }}">
              <button type="submit" class="secondary">Удалить</button>
            </form>
            {% else %}—{% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if entries|length == 0 %}
        <tr><td colspan="5" class="muted">Пока нет записей за эту дату</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <style>
    /* Сетка формы табеля: все поля в одну строку на десктопе */
    .ts-form{
      display:grid;
      grid-template-columns:1.1fr 1.6fr .7fr 2fr auto;
      gap:1rem;
      align-items:end;
    }
    @media (max-width: 900px){
      .ts-form{ grid-template-columns:1fr; }
    }
  </style>

  <nav class="pager">
    <a href="/timesheet?date={{ prev.isoformat() }}" class="contrast">← {{ prev.strftime("%d.%m") }}</a>
    {% if date != today %}
      <a href="/timesheet?date={{ today.isoformat() }}" class="secondary">Сегодня · {{ today.strftime("%d.%m") }}</a>
    {% else %}
      <span class="badge status-done">Сегодня · {{ today.strftime("%d.%m") }}</span>
    {% endif %}
    {% if date < today %}
      <a href="/timesheet?date={{ next.isoformat() }}" class="contrast">{{ next.strftime("%d.%m") }} →</a>
    {% endif %}
  </nav>

  <p class="muted">Текущая дата табеля: {{ date.strftime("%d.%m.%Y") }}. Сегодня: {{ today.strftime("%d.%m.%Y") }}.</p>

  <p><a href="/timesheet/grid">Вид «Календарь задач»</a> · <a href="/calendar/team">Календарь отдела</a></p>
{% endblock %}
