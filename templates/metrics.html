{% extends "base.html" %}
{% block content %}
  <header class="page-header">
    <div>
      <h1>Метрики отдела</h1>
      <p class="muted">Актуальные данные за последние недели</p>
    </div>
  </header>

  <section class="metrics-grid">
    <article class="surface chart-card">
      <header>
        <h2>Utilization по сотрудникам</h2>
        <p class="muted">последние 28 дней</p>
      </header>
      <canvas id="c1" aria-label="Utilization сотрудников за последние 28 дней" role="img"></canvas>
    </article>
    <article class="surface chart-card">
      <header>
        <h2>План/Факт часов по проектам</h2>
        <p class="muted">сравнение по проектам</p>
      </header>
      <canvas id="c2" aria-label="План и факт часов по проектам" role="img"></canvas>
    </article>
    <article class="surface chart-card">
      <header>
        <h2>Нагрузка по отделам</h2>
        <p class="muted">часы за 14 дней</p>
      </header>
      <canvas id="c3" aria-label="Нагрузка по отделам за 14 дней" role="img"></canvas>
    </article>
  </section>
  <script>
    async function draw() {
      const u = await (await fetch('/api/metrics/utilization')).json();
      const ctx1 = document.getElementById('c1');
      new Chart(ctx1, {
        type: 'bar',
        data: { labels: u.labels,
          datasets: [
            { label: 'Проектные часы', data: u.project_hours, stack: 's' },
            { label: 'Непроектные часы', data: u.nonproject_hours, stack: 's' },
            { label: 'Отсутствия', data: u.leave_hours, stack: 's' },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          layout: { padding: 16 },
          plugins: {
            legend: {
              position: 'top',
              align: 'start',
              labels: { usePointStyle: true, boxWidth: 10, padding: 14 }
            }
          },
          scales: {
            x: { stacked: true, ticks: { maxRotation: 0, autoSkip: false } },
            y: { stacked: true }
          }
        }
      });

      const p = await (await fetch('/api/metrics/project_load')).json();
      const ctx2 = document.getElementById('c2');
      new Chart(ctx2, {
        type: 'bar',
        data: { labels: p.labels,
          datasets: [
            { label: 'План', data: p.planned_hours },
            { label: 'Факт', data: p.actual_hours },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          layout: { padding: 16 },
          plugins: {
            legend: {
              position: 'top',
              align: 'start',
              labels: { usePointStyle: true, boxWidth: 10, padding: 14 }
            }
          },
          scales: {
            x: { ticks: { maxRotation: 0, autoSkip: false } }
          }
        }
      });

      const d = await (await fetch('/api/metrics/department_workload')).json();
      const ctx3 = document.getElementById('c3');
      new Chart(ctx3, {
        type: 'bar',
        data: { labels: d.labels, datasets: [{ label: 'Часы', data: d.hours }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          layout: { padding: 16 },
          plugins: {
            legend: {
              position: 'top',
              align: 'start',
              labels: { usePointStyle: true, boxWidth: 10, padding: 14 }
            }
          },
          scales: {
            x: { ticks: { maxRotation: 0, autoSkip: false } }
          }
        }
      });
    }
    draw();
  </script>
{% endblock %}
