# TimeFlow — лёгкий тайм‑трекер и учёт загрузки отдела (без сервера)

**Кейс:** отдел ремонта авиационной техники. Задачи с кодами типа `C7И****` считаются *проектными*, остальное — *непроектная деятельность*. Нужно видеть загрузку людей, проект/непроект %, часы, быстрый ввод табеля, учёт отсутствий и простые метрики для руководителей. Нужен вариант, который запускается на ноутбуках без выделенного сервера.

## Почему так

- **Python + FastAPI + SQLite (WAL)** — всё локально. Общая БД — это **один файл** в общей папке (сетевой `\\share\...` или папка, синхронизируемая OneDrive/Google Drive). SQLite в режиме WAL допускает параллельную работу команды при умеренной нагрузке.
- **Веб‑интерфейс** на локальном `http://127.0.0.1:8000`. Пользователь запускает приложение, оно работает «как десктоп», но интерфейс в браузере.
- **Роли**: employee / manager / admin. Проекты/задачи создают менеджеры/админы. Внесение времени за другие даты уходит на согласование.
- **Календарь/отсутствия**: заявки «удалёнка, больничный, отпуск…» отправляются на согласование и при одобрении автоматически создают часы отсутствия в табеле.
- **Напоминания**: веб‑уведомление на 16:30 локального времени «пора проставить часы».

> Для производственной эксплуатации при росте нагрузки можно заменить SQLite на PostgreSQL — код моделей и запросов готов к этому без больших изменений.

## Быстрый старт (Windows / macOS / Linux)

1. Установить Python 3.10+.
2. Скачать архив с кодом и распаковать.

3. В консоли внутри папки проекта:
   ```bash
   python -m venv .venv
   .venv/Scripts/activate  # Windows
   # source .venv/bin/activate  # macOS/Linux
   pip install -r requirements.txt
   ```

4. **Указать путь к общей БД** (папка на сетевом диске/облаке), включающий имя файла, например:
   ```bash
   set TIMEFLOW_DB=Z:\TimeFlow\timeflow.db       # Windows (cmd)
   # export TIMEFLOW_DB="/Volumes/share/TimeFlow/timeflow.db"  # macOS/Linux
   ```
   Если переменную не установить, БД создастся рядом с кодом (`timeflow.db`).

   Дополнительно можно настроить:
   - `TIMEFLOW_SECRET_KEY` — ключ для сессий (строка).
   - `TIMEFLOW_SHIFT_HOURS` — норма часов за день (по умолчанию 8.0).
   - `TIMEFLOW_ALLOW_BACKFILL_DAYS` — на сколько дней назад разрешён прямой ввод времени (по умолчанию 1 — только «вчера»).
   - `TIMEFLOW_ENABLE_SIGNUP=true` — разрешить саморегистрацию (по умолчанию выключена).

5. Создать первого администратора:
   ```bash
   python seed_admin.py
   ```

6. Запустить приложение:
   ```bash
   uvicorn app:app --reload
   ```

7. Открыть в браузере `http://127.0.0.1:8000` и войти под админом. Создать пользователей, проекты и выдать роли.

## Роли и права

- **Employee**: обновляет статусы задач; вносит время (за вчера — сразу; за другие даты — уходит на согласование); подаёт заявки на отсутствие.
- **Manager**: всё как employee + создаёт проекты и задачи, согласует «нестандартное» время и отсутствия, видит метрики, закрывает проекты.
- **Admin**: управление пользователями/ролями, все права менеджера.

## Бизнес‑правила, реализованные в MVP

- Проекты/задачи создаются **только** менеджером/админом.
- Время можно вносить **только за предыдущий день** (настройка `TIMEFLOW_ALLOW_BACKFILL_DAYS`). За более ранние даты запись уходит в «на согласование» и отображается менеджеру.
- Заявки на отсутствие требуют согласования; при одобрении автоматически создаются записи табеля с типом `leave`.
- Фиксируются чек‑ин/чек‑аут на день; на дэшборде показывается рекомендованное время ухода = `чек‑ин + SHIFT_HOURS`.
- Отдел видит взаимно «кто чем занят» сегодня: текущая задача, статус, чек‑ин/чек‑аут.
- Метрики: **utilization** проект/непроект/отсутствия по людям; План/Факт часов по проектам; нагрузка по отделам за 14 дней.

## Полезные метрики для руководства (в планах)
- **Процент проектной загрузки (Project Utilization)** = проектные часы / (проектные + непроектные).
- **Воронка блокировок**: суммарные часы задач в статусах `waiting`/`on_pause` по причинам (из комментариев).
- **Прогноз выгорания**: скользящее среднее часов > 9 ч/день в течение N дней — флаг «риск».
- **Точность оценок**: `факт / план` по проектам и по владельцам проектов.
- **Lead time**: от старта задачи до `done` по категориям ремонта.
- **Распределение задач**: сколько активных проектных задач на сотрудника, коэффициент перекрытия по отделам.

## Замечания по SQLite
- Включён режим `WAL` и `busy_timeout=5000` — это снижает конфликты блокировок.
- Никогда не открывайте `timeflow.db` одновременно «руками» (например, в SQLiteStudio) — это может держать блокировки.

## Безопасность и доступ
- Сессии с подписью по секретному ключу.
- Пароли хешируются `bcrypt` (Passlib).
- Рекомендуется хранить БД на защищённой сетевой шаре с ограничением доступа только для подразделения.

## Переезд на PostgreSQL (опционально)
- Заменить `DATABASE_URL` в `db.py`, например: `postgresql+psycopg://user:pass@host/db`.
- Выполнить миграцию данных из SQLite (скрипт миграции можно будет написать отдельно).

---

## Структура
```
app.py          # точки входа и маршруты
models.py       # модели SQLAlchemy
db.py           # подключение и PRAGMA
auth.py         # аутентификация, роли, сессии
config.py       # конфиг из переменных среды
templates/      # HTML-шаблоны (PicoCSS, Chart.js)
static/         # статика (пока пусто)
requirements.txt
seed_admin.py   # утилита создания первого админа
```
